name: Premainnet Tests

on:
  schedule:
    - cron:  '30 * * * *'
  push:
    branches: [ master, auto ]

jobs:
  test-pre-main-net:
    name: Pre main net test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
    - uses: actions/checkout@v2
      with:
        ref: ${{ secrets.PREMAINNET_GIT_REVISION }}
    - name: Version Info
      run: rustc --version; cargo --version; rustup --version  
    - name: Environment Setup
      run: |
        echo 'export NODES=a11d2e31854e811eaa1f702474484dd1-21dcb00bef9f6cc0.elb.us-west-2.amazonaws.com:80,\
        a1981c0ab68b011eab1bb02f729e0dd7-3c9f20567ceb2efd.elb.us-west-2.amazonaws.com:80,\
        a569b48655cbc40d092379f55e630966-e1f284c7eb8add73.elb.eu-west-1.amazonaws.com:80,\
        aa4d66f81665240019022d50326c1654-cf61b8e99df12293.elb.eu-west-1.amazonaws.com:80,\
        a5b46d6b8b23e42538ec0de5f0680350-46d80c995764cdd9.elb.us-west-2.amazonaws.com:80,\
        a88662827a2d341bbb7beb883d6e32b9-2e166f46672c7f2b.elb.us-east-1.amazonaws.com:80,\
        libra-fullnode-pre-mainnet.shopifyapps.com:80,\
        20.50.43.42:80,\
        34.68.134.0:80,\
        35.193.177.28:80,\
        3.230.173.177:32251'
        echo "::set-env name=NODES::$(NODES)"
        echo "::set-env name=CARGO_INCREMENTAL::0"
        echo '::set-env name=LIBRA_DUMP_LOGS::1'
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake curl clang llvm gcc-powerpc-linux-gnu
        rustup component add clippy rustfmt
    - name: Build config-builder
      run: |
        cargo build -p config-builder
    - name: Build cluster-test
      run: |
        cargo build -p cluster-test
    - name: Generate premaintnet config key
      env:
        PREMAINNET_NUM_VAL: ${{ secrets.PREMAINNET_NUM_VAL }}
        PREMAINNET_CONFIG_SEED: ${{ secrets.PREMAINNET_CONFIG_SEED }}
      run: |
        cargo run -p config-builder -- faucet \
        --output-dir "/tmp/config" \
        --validators-in-genesis $PREMAINNET_NUM_VAL \
        --seed $PREMAINNET_CONFIG_SEED
    - name: Premainnet cluster test
      run: |
        cargo run -p cluster-test -- --swarm --emit-tx --mint-file /tmp/config/mint.key --peers $NODES
    #    
    #  - slack/status:
    #      fail_only: true
    #      webhook: "${WEBHOOK_PREMAINNET}"
    #      failure_message: "<@channel> Cluster test failed on premainnet :ferris-detective:"
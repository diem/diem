name: "Github Changes"
description: "Compute by any means necessary the changes attempting to be merged, or that have been merged in to a branch."
inputs:
  workflow-file:
    description: "local repository path to the workflow file, no leading slash."
    required: true
outputs:
  base-githash:
    description: The shared git hash of a pr, a bors target branch, or the last successful build of the workflow-file on the branch.
    value: ${{ steps.calc.outputs.base-githash }}
  target-branch:
    description: If a target branch exists for either bors or a pr, the branch.
    value: ${{ steps.calc.outputs.target-branch }}
  pull-request-number:
    description: If a pullrequest number can be found, either in bors, or in a pr, the number.
    value: ${{ steps.calc.outputs.pull-request-number }}
runs:
  using: "composite"
  steps:
    - id: calc
      run: |
        if [[ $(git log --pretty=format:"%H" -n 26 | wc -l) < 2 ]]; then
          echo It is likely that checkout did not return more than one commit, recommend calling checkout with fetch-depth: 25 1>&2
          echo BASE_GITHASH is likely to not be found even if it would otherwise be the immediate prior revision. 1>&2
        fi

        eval $(./.github/actions/changes/get_pr_info.sh -w "${WORKFLOW}" -b -d)

        echo "TARGET_BRANCH=${TARGET_BRANCH}" >> $GITHUB_ENV
        echo "PULL_REQUEST=${PULL_REQUEST}" >> $GITHUB_ENV
        echo "CHANGED_FILE_OUTPUTFILE=${CHANGED_FILE_OUTPUTFILE}" >> $GITHUB_ENV
        echo "BASE_GITHASH=${BASE_GITHASH}" >> $GITHUB_ENV

        echo "::set-output name=base-githash::$(echo $BASE_GITHASH)"
        echo "::set-output name=target-branch::$(echo $TARGET_BRANCH)"
        echo "::set-output name=pull-request-number::$(echo $PULL_REQUEST)"

        echo
        echo CALCULATED:
        echo TARGET_BRANCH=${TARGET_BRANCH}
        echo PULL_REQUEST=${PULL_REQUEST}
        echo CHANGED_FILE_OUTPUTFILE=${CHANGED_FILE_OUTPUTFILE}
        echo BASE_GITHASH=${BASE_GITHASH}
        echo
        echo CHANGED FILES:
        cat ${CHANGED_FILE_OUTPUTFILE}
        echo
        echo Actions Provided Environment:
        set | grep GITHUB
      shell: bash
      env:
        WORKFLOW: ${{ inputs.workflow-file }}
